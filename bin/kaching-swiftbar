#!/usr/bin/env ruby
# frozen_string_literal: true

# This is a script for use with SwiftBar (https://swiftbar.app/) or BitBar
# (https://getbitbar.com)
#
# Symlink it into your plugins folder as <app_name>.<interval>.rb

# <bitbar.title>Kaching</bitbar.title>
# <bitbar.version>v1.0</bitbar.version>
# <bitbar.author>Aaron Madlon-Kay</bitbar.author>
# <bitbar.author.github>amake</bitbar.author.github>
# <bitbar.desc>Monitor sales on the App Store and Google Play.</bitbar.desc>
# <bitbar.dependencies>ruby</bitbar.dependencies>
# <bitbar.abouturl>https://github.com/amake/kaching</bitbar.abouturl>

Dir.chdir(File.expand_path('..', __dir__))

require 'bundler/setup'
require 'kaching'
require 'date'

CONFIG_PATH = 'config.json'

# @param data [Date]
# @return [String]
def relativize(date)
  if date.today?
    'Today'
  elsif date.yesterday?
    'Yesterday'
  elsif (Date.today - date) < 7
    "#{(Date.today - date).to_i} days ago"
  else
    date.to_s
  end
end

raise "Create #{CONFIG_PATH} first" unless File.exist?(CONFIG_PATH)

Kaching::Configure.from_json_file(CONFIG_PATH)

apple_date, apple_count = Kaching::AppStore.latest_sales_count
google_date, google_count = Kaching::GooglePlay.latest_sales_count

app_name = File.basename($PROGRAM_NAME).split('.').first || 'My App'

puts(<<~MSG)
  :applelogo: #{apple_count} ðŸ¤– #{google_count}
  ---
  #{app_name} sales
  â€¢ App Store: #{apple_count} (#{relativize(apple_date)})
  â€¢ Google Play: #{google_count} (#{relativize(google_date)})
MSG
