#!/usr/bin/env ruby
# frozen_string_literal: true

# This is a script for use with SwiftBar (https://swiftbar.app/) or BitBar
# (https://getbitbar.com)
#
# Symlink it into your plugins folder as <app_name>.<interval>.rb

# <bitbar.title>Kaching</bitbar.title>
# <bitbar.version>v1.0</bitbar.version>
# <bitbar.author>Aaron Madlon-Kay</bitbar.author>
# <bitbar.author.github>amake</bitbar.author.github>
# <bitbar.desc>Monitor sales on the App Store and Google Play.</bitbar.desc>
# <bitbar.dependencies>ruby</bitbar.dependencies>
# <bitbar.abouturl>https://github.com/amake/kaching</bitbar.abouturl>

Dir.chdir(File.expand_path('..', __dir__))

require 'bundler/setup'
require 'kaching'
require 'date'

CONFIG_PATH = 'config.json'

# @param data [Date]
# @return [String]
def relativize(date)
  if date.today?
    'Today'
  elsif date.yesterday?
    'Yesterday'
  elsif (Date.today - date) < 7
    "#{(Date.today - date).to_i} days ago"
  else
    date.to_s
  end
end

# @param proceeds [Hash<String,Numeric>]
# @param to_currency [String]
# @return [Numeric]
def proceeds_total(proceeds, to_currency: 'USD')
  proceeds.sum do |currency, amount|
    Kaching::Currency.convert(amount: amount, from: currency, to: to_currency)
  end
end

def vendor_summary(date, units, proceeds)
  proceeds_usd = proceeds_total(proceeds)
  relative_date = relativize(date)
  case units
  when 0 then "- (#{relative_date})"
  when 1 then format('1 unit Â· US$%<proceeds>.2f (%<date>s)', proceeds: proceeds_usd, date: relative_date)
  else
    format('%<units>s units Â· US$%<proceeds>.2f (%<date>s)', units: units, proceeds: proceeds_usd, date: relative_date)
  end
end

raise "Create #{CONFIG_PATH} first" unless File.exist?(CONFIG_PATH)

Kaching::Configure.from_json_file(CONFIG_PATH)

apple_date, apple_count, apple_proceeds = Kaching::AppStore.latest_sales_count
google_date, google_count, google_proceeds = Kaching::GooglePlay.latest_sales_count

app_name = File.basename($PROGRAM_NAME).split('.').first || 'My App'

puts(<<~MSG)
  :applelogo: #{apple_count} ðŸ¤– #{google_count}
  ---
  #{app_name} sales
  â€¢ App Store: #{vendor_summary(apple_date, apple_count, apple_proceeds)}
  â€¢ Google Play: #{vendor_summary(google_date, google_count, google_proceeds)}
MSG
